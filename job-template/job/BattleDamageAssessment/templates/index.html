<!doctype html>
<html lang="zh-CN">
<head>
    <meta charset="utf-8">
    <title>ç›®æ ‡æ¯ä¼¤è¯„ä¼°</title>
    <style>
        body{margin:0;font-family:"Microsoft YaHei",sans-serif;background:#f5f5f5;}
        h1{text-align:center;margin:20px 0;color:#333;}
        .container{max-width:1400px;margin:0 auto;padding:20px;}
        
        /* ä¸»å¸ƒå±€ï¼šå·¦å³åˆ†æ  */
        .main-layout{display:flex;gap:40px;margin-top:30px;align-items:flex-start;}
        .left-panel{flex:0 0 450px;}
        .right-panel{flex:1;}
        
        /* åœºæ™¯é€‰æ‹©åŒºåŸŸ */
        .scene-selector{display:flex;flex-direction:column;gap:20px;align-items:center;padding-top:50px;}
        .scene-selector-left{display:flex;flex-direction:column;align-items:center;}
        .scene-selector h3{margin-bottom:15px;color:#666;text-align:center;margin-top:0;}
        .scene-buttons{display:flex;flex-direction:row;gap:15px;max-width:300px;}
        .scene-btn{padding:12px 30px;font-size:16px;background:#4CAF50;color:white;border:none;border-radius:5px;cursor:pointer;transition:all 0.3s;min-width:120px;}
        .scene-btn:hover{background:#45a049;}
        .scene-btn.active{background:#2E7D32;}
        
        /* ä¸Šä¼ åŒºåŸŸ */
        .upload-section{margin-bottom:30px;text-align:center;}
        #uploadBtn{display:block;margin:10px auto;padding:10px 20px;font-size:16px;background:#2196F3;color:white;border:none;border-radius:5px;cursor:pointer;}
        #uploadBtn:hover{background:#0b7dda;}
        #uploadBtn:disabled{background:#ccc;cursor:not-allowed;}
        #loader{text-align:center;margin-top:30px;font-size:14px;color:#555;}
        
        /* ç»“æœåŒºåŸŸ */
        .result{display:flex;justify-content:center;margin-top:0;gap:40px;}
        .result img{border:2px solid #2196F3;border-radius:8px;box-shadow:0 4px 12px rgba(0,0,0,0.15);transition:transform 0.3s;width:400px;display:block;}
        .result img:hover{transform:scale(1.02);}
        .image-label{text-align:center;margin-top:12px;color:#333;font-weight:bold;font-size:16px;}
        
        /* åœºæ™¯é¢„è§ˆ - ä¸æ¯ä¼¤å›¾ç‰‡å¯¹é½ */
        .scene-preview{display:flex;flex-direction:column;align-items:center;width:400px;}
        .scene-preview img{width:400px;border:2px solid #4CAF50;border-radius:5px;box-shadow:0 2px 8px rgba(0,0,0,0.1);display:block;}
        
        /* æ¯ä¼¤å›¾ç‰‡æ¨¡å— - ä¸åœºæ™¯å›¾ç‰‡å¯¹é½ */
        .damage-panel{display:flex;flex-direction:column;align-items:center;width:400px;}
        
        /* å ä½ç¬¦æ ·å¼ */
        .placeholder{width:400px;height:300px;background:#f0f0f0;border:2px dashed #ccc;border-radius:8px;display:flex;align-items:center;justify-content:center;color:#999;font-size:14px;position:relative;}
        
        /* è¯†åˆ«ç»“æœå›¾ç‰‡åŒºåŸŸ */
        .image-wrapper{display:flex;flex-direction:column;align-items:center;width:400px;}
        
        /* ä¿¡æ¯åŒºåŸŸ */
        .info-wrapper{display:flex;flex-direction:column;align-items:center;margin-top:30px;}
        .info{background:#fff;padding:15px 25px;border-radius:8px;text-align:left;line-height:1.8;box-shadow:0 4px 12px rgba(0,0,0,0.15);width:600px;}
        .info strong{color:#667eea;margin-right:8px;}
        
        /* ä¿¡æ¯åŒºåŸŸå ä½ç¬¦ */
        .info-placeholder{width:600px;height:150px;background:#f0f0f0;border:2px dashed #ccc;border-radius:8px;display:flex;align-items:center;justify-content:center;color:#999;font-size:12px;}
    </style>
</head>
<body>
    <h1>ç›®æ ‡æ¯ä¼¤è¯„ä¼°</h1>
    
    <div class="container">
        <div class="main-layout">
            <!-- å·¦ä¾§ï¼šåœºæ™¯é€‰æ‹© -->
            <div class="left-panel">
                <div class="scene-selector">
                    <div class="scene-selector-left">
                        <h3>è¯·é€‰æ‹©åœºæ™¯</h3>
                        <div class="scene-buttons">
                            <button class="scene-btn" data-scene="1">åœºæ™¯ä¸€</button>
                            <button class="scene-btn" data-scene="2">åœºæ™¯äºŒ</button>
                        </div>
                    </div>
                    <div class="scene-preview" id="scenePreview">
                        <p class="image-label">åœºæ™¯å›¾ç‰‡ï¼ˆæ¯ä¼¤å‰ï¼‰</p>
                        <div class="placeholder" id="scenePlaceholder">ç­‰å¾…é€‰æ‹©åœºæ™¯</div>
                        <img id="sceneImg" alt="åœºæ™¯å›¾ç‰‡" style="display:none;">
                    </div>
                </div>
            </div>

            <!-- å³ä¾§ï¼šä¸Šä¼ å’Œç»“æœå±•ç¤º -->
            <div class="right-panel">
                <!-- ä¸Šä¼ åŒºåŸŸ -->
                <div class="upload-section">
                    <h3>ä¸Šä¼ æ¯ä¼¤åå›¾ç‰‡</h3>
                    <input type="file" id="fileInput" accept="image/*" style="display:none;">
                    <button id="uploadBtn" disabled>ä¸Šä¼ å›¾ç‰‡</button>
                </div>

                <div id="loader" style="display:none;">æ­£åœ¨æ£€æµ‹ï¼Œè¯·ç¨å€™â€¦</div>

                <!-- ç»“æœå±•ç¤ºåŒº -->
                <div id="resultPanel">
                    <div class="result">
                        <div class="damage-panel">
                            <p class="image-label">æ¯ä¼¤åå›¾ç‰‡</p>
                            <div class="placeholder" id="damagePlaceholder">ç­‰å¾…ä¸Šä¼ å›¾ç‰‡</div>
                            <img id="damageImg" alt="æ¯ä¼¤åå›¾ç‰‡" style="display:none;">
                        </div>
                        <div class="image-wrapper">
                            <p class="image-label">è¯†åˆ«ç»“æœ</p>
                            <div class="placeholder" id="resultPlaceholder">ç­‰å¾…è¯†åˆ«ç»“æœ</div>
                            <img id="resultImg" alt="è¯†åˆ«ç»“æœ" style="display:none;">
                        </div>
                    </div>
                    <div class="info-wrapper">
                        <p class="image-label">æ£€æµ‹ä¿¡æ¯</p>
                        <div class="info-placeholder" id="infoPlaceholder">ç­‰å¾…æ£€æµ‹ç»“æœ</div>
                        <div class="info" id="infoText" style="display:none;"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
    const fileInput = document.getElementById('fileInput');
    const uploadBtn = document.getElementById('uploadBtn');
    const loader    = document.getElementById('loader');
    const resultPanel=document.getElementById('resultPanel');
    const scenePreview = document.getElementById('scenePreview');
    const sceneImg = document.getElementById('sceneImg');
    const scenePlaceholder = document.getElementById('scenePlaceholder');
    const damageImg = document.getElementById('damageImg');
    const damagePlaceholder = document.getElementById('damagePlaceholder');
    const resultImg = document.getElementById('resultImg');
    const resultPlaceholder = document.getElementById('resultPlaceholder');
    const infoText = document.getElementById('infoText');
    const infoPlaceholder = document.getElementById('infoPlaceholder');
    
    let selectedScene = null;

    // åœºæ™¯é€‰æ‹©
    document.querySelectorAll('.scene-btn').forEach(btn => {
        btn.addEventListener('click', () => {
            // ç§»é™¤æ‰€æœ‰activeçŠ¶æ€
            document.querySelectorAll('.scene-btn').forEach(b => b.classList.remove('active'));
            // æ·»åŠ activeçŠ¶æ€
            btn.classList.add('active');
            selectedScene = btn.dataset.scene;
            
            // æ˜¾ç¤ºåœºæ™¯å›¾ç‰‡ï¼Œéšè—å ä½ç¬¦
            sceneImg.src = `/image/${selectedScene}.png?folder=scene`;
            scenePlaceholder.style.display = 'none';
            sceneImg.style.display = 'block';
            
            // å¯ç”¨ä¸Šä¼ æŒ‰é’®
            uploadBtn.disabled = false;
            
            // é‡ç½®æ–‡ä»¶è¾“å…¥
            fileInput.value = '';
            
            // é‡ç½®ç»“æœåŒºåŸŸ
            damagePlaceholder.style.display = 'block';
            damageImg.style.display = 'none';
            resultPlaceholder.style.display = 'block';
            resultImg.style.display = 'none';
            infoPlaceholder.style.display = 'flex';
            infoText.style.display = 'none';
        });
    });

    // ä¸Šä¼ æŒ‰é’®
    uploadBtn.addEventListener('click', () => fileInput.click());

    // æ–‡ä»¶é€‰æ‹©
    fileInput.addEventListener('change', async ()=>{
        const file = fileInput.files[0];
        if(!file || !selectedScene) return;

        // 1. ç«‹å³æœ¬åœ°é¢„è§ˆæ¯ä¼¤å›¾ç‰‡ï¼Œéšè—å ä½ç¬¦
        damageImg.src = URL.createObjectURL(file);
        damagePlaceholder.style.display = 'none';
        damageImg.style.display = 'block';
        resultPlaceholder.style.display = 'block';  // ç»“æœå ä½ç¬¦ä¿æŒæ˜¾ç¤º
        resultImg.style.display = 'none';
        infoPlaceholder.style.display = 'flex';
        infoText.style.display = 'none';

        loader.style.display = 'block';

        try{
            const filename = `${selectedScene}.png`;
            const r = await fetch('/upload',{
                method:'POST',
                headers:{'Content-Type':'application/json'},
                body: JSON.stringify({
                    scene_id: selectedScene,
                    filename: filename
                })
            });
            const data = await r.json();
            if(!r.ok) throw new Error(data.error || 'æœªçŸ¥é”™è¯¯');

            // 2. æ˜¾ç¤ºè¯†åˆ«ç»“æœå›¾ï¼Œéšè—å ä½ç¬¦
            resultImg.src = data.result_url;
            resultPlaceholder.style.display = 'none';
            resultImg.style.display = 'block';
            
            // æ˜¾ç¤ºä¿¡æ¯æ–‡æœ¬ï¼Œéšè—å ä½ç¬¦
            const formattedTexts = data.texts.map(text => {
                if (text.includes('è€—æ—¶')) {
                    return `<strong>â±ï¸</strong> ${text}`;
                } else if (text.includes('æ¯ä¼¤ç­‰çº§')) {
                    const level = text.includes('é«˜') ? 'ğŸ”´' : text.includes('ä¸­') ? 'ğŸŸ¡' : 'ğŸŸ¢';
                    return `<strong>${level}</strong> ${text}`;
                } else if (text.includes('å»ºè®®')) {
                    return `<strong>ğŸ’¡</strong> ${text}`;
                }
                return text;
            });
            infoPlaceholder.style.display = 'none';
            infoText.innerHTML = formattedTexts.join('<br>');
            infoText.style.display = 'block';
        }catch(e){
            alert('å‡ºé”™ï¼š'+e.message);
        }finally{
            loader.style.display = 'none';
        }
    });
    </script>
</body>
</html>
